<div class="content-page">
  <div class="content">
    <!-- Start Content-->
    <div class="content">
      <div id="loading" class="loading-container">
        <div class="loading-spinner">
          <i class="fas fa-spinner fa-spin"></i>
        </div>
      </div>

      <div id="dialog" class="dialog-container">
        <div class="dialog-content">
          <span id="dialog-message"></span>
          <button onclick="hideDialog()">Ok</button>
        </div>
      </div>
      <div class="container-fluid">
        <div class="row">
          <div class="col-lg-12">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Thống kê</h3>
              </div>
            </div>
          </div>

          <!-- Thong ke san pham ban chay -->
          <div class="col-md-12">
            <!-- Customer List -->
            <div class="card card-primary card-outline">
              <div class="card-header" style="display: flex;flex-direction: row;justify-content: space-between;">
                <h5 class="card-title">Top sản phẩm bán chạy</h5>
              </div>
              <!-- /.card-header -->
              <div class="card-body">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>STT</th>
                      <th>Tên sản phẩm</th>
                      <th>Thương hiệu</th>
                      <th>Giá</th>
                      <th>Tồn kho</th>
                      <th>Đã bán</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% let index=1; %>
                      <% listTopProduct.forEach((row)=> { %>
                        <tr onclick="window.location.href='/product/detail-products/<%= row._id %>';"
                          style="cursor: pointer;">
                          <td>
                            <%= index %>
                          </td>
                          <td>
                            <img src="<%= row.photoUrls[0] %>" alt="Product Image" height="100" width="100"
                              style="margin-right: 10px; object-fit: contain;">
                            <%= row.name %>
                          </td>
                          <td>
                            <%= row.brand.name %>
                          </td>
                          <td>
                            <%= row.price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".") %>$
                          </td>
                          <td>
                            <%= row.quantity %>
                          </td>
                          <td>
                            <%= row.totalSold %>
                          </td>
                        </tr>
                        </a>
                        <% index++; %>
                          <% }) %>
                  </tbody>
                </table>
              </div>
              <!-- /.card-body -->
            </div>
            <!-- /.card -->
          </div>

          <div class="col-md-12">
            <div class="card">
              <div class="card card-primary card-outline">
                <div class="card-header" style="display: flex;flex-direction: row;justify-content: space-between;">
                  <h5 class="card-title">Doanh thu</h5>
                </div>
                <div class="row" style="display: flex; justify-content: end; margin-top: 20px; margin-right: 8px;">
                  <div style="width: 300px; float: inline-end;">
                    <div class="input-group">
                      <input type="text" class="form-control" id="date-range" placeholder="Select Date Range">
                      <div class="input-group-append">
                        <span class="input-group-text">
                          <i class="fa fa-calendar"></i>
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-lg-7">
                    <div data-coreui-start-date="2022/08/03 02:34:17 AM" data-coreui-end-date="2022/09/17 11:29:41 PM"
                      data-coreui-locale="en-US" data-coreui-timepicker="true" data-coreui-toggle="date-range-picker">
                    </div>
                  </div>
                </div>
                <div class="card-body">
                  <div style="display: flex; flex-direction: row; gap: 10px;">
                    <div class="card" style="width: -webkit-fill-available;">
                      <div class="card-body widget-user">
                        <div class="text-center">
                          <span class="text-primary"
                            style="display: flex; flex-direction: row; justify-content: center; align-items: center;">
                            <h2 class="fw-normal text-primary" data-plugin="counterup" id="revenueNumber">
                              <%= revenue %>
                            </h2>$
                          </span>
                          <h5>
                            Doanh số
                          </h5>
                        </div>
                      </div>
                    </div>

                    <div class="card" style="width: -webkit-fill-available;">
                      <div class="card-body widget-user">
                        <div class="text-center">
                          <h2 class="fw-normal text-primary" data-plugin="counterup" id="quantityProduct">
                            <%= totalSold %>
                          </h2>
                          <h5>
                            Sản phẩm đã bán
                          </h5>
                        </div>
                      </div>
                    </div>

                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-12">
            <div class="card">
              <div class="card card-primary card-outline">
                <div class="card-header" style="display: flex;flex-direction: row;justify-content: space-between;">
                  <h5 class="card-title">Hoạt động</h5>
                </div>

                <div class="card-body" style="display: flex; flex-direction: row; gap: 10px;">
                  <div class="card" style="width: -webkit-fill-available;">
                    <div class="card-body widget-user">
                      <div class="text-center">
                        <span class="text-primary"
                          style="display: flex; flex-direction: row; justify-content: center; align-items: center;">
                          <h2 class="fw-normal text-primary" data-plugin="counterup">
                            <%= activity.quantityStaff %>
                          </h2>
                        </span>
                        <h5>
                          Nhân viên
                        </h5>
                      </div>
                    </div>
                  </div>
                  <div class="card" style="width: -webkit-fill-available;">
                    <div class="card-body widget-user">
                      <div class="text-center">
                        <span class="text-primary"
                          style="display: flex; flex-direction: row; justify-content: center; align-items: center;">
                          <h2 class="fw-normal text-primary" data-plugin="counterup">
                            <%= activity.quantityClient %>
                          </h2>
                        </span>
                        <h5>
                          Khách hàng
                        </h5>
                      </div>
                    </div>
                  </div>
                  <div class="card" style="width: -webkit-fill-available;">
                    <div class="card-body widget-user">
                      <div class="text-center">
                        <span class="text-primary"
                          style="display: flex; flex-direction: row; justify-content: center; align-items: center;">
                          <h2 class="fw-normal text-primary" data-plugin="counterup">
                            <%= activity.quantityProduct %>
                          </h2>
                        </span>
                        <h5>
                          Sản phẩm
                        </h5>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>

      </div>
    </div>
  </div>
</div>
</div>

<script>
  const baseURL = window.location.protocol + "//" + window.location.host;

  $(document).ready(function () {
    $('#date-range').on('apply.daterangepicker', function (ev, picker) {
      var startDate = picker.startDate.format('YYYY-MM-DD');
      var endDate = picker.endDate.format('YYYY-MM-DD');

      fetch(`${baseURL}/api/statistical?startDate=${startDate}&endDate=${endDate}`, {
        method: "GET",
      })
        .then((response) => {
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          return response.json();
        })
        .then((body) => {
          isSuccess = true;
          hideLoading();
          const revenue = body.data.revenue;
          const productSold = body.data.totalSold;
          $('#revenueNumber').text(revenue);
          $('#revenueNumber').counterUp({
            delay: 10,
            time: 1000
          });
          $('#quantityProduct').text(productSold);
          $('#quantityProduct').counterUp({
            delay: 10,
            time: 1000
          });
        })
        .catch((error) => {
          isSuccess = false;
          hideLoading();
          showDialog("Lỗi: " + error.message);
          console.error("Error:", error);
        });
    });
  });

  function showLoading() {
    document.getElementById("loading").style.display = "block";
  }

  function hideLoading() {
    document.getElementById("loading").style.display = "none";
  }

  function showDialog(message) {
    document.getElementById("dialog-message").textContent = message;
    document.getElementById("dialog").style.display = "block";
  }

  function hideDialog() {
    document.getElementById("dialog").style.display = "none";
    if (isSuccess) {
      isSuccess = false;
    }
  }
</script>